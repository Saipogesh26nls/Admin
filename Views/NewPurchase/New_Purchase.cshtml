@model Admin.Models.New_Purchase
    @{ 
        var models = ViewBag.PM;
    }
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="~/Content/Purchase.css" />
    <style>
        table.scroll {
            border-spacing: 0;
            border: 2px solid black;
            width: auto;
        }

            table.scroll tbody,
            table.scroll thead {
                display: block;
            }

        thead tr th {
            height: 20px;
            line-height: 20px;
        }

        table.scroll tbody {
            height: 200px;
            overflow-y: auto;
            overflow-x: auto;
        }

        tbody {
            border-top: 2px solid black;
        }

            tbody td, thead th {
                border-right: 1px solid black;
            }

                tbody td:last-child, thead th:last-child {
                    border-right: none;
                }
        #list:hover {
            background-color: aliceblue;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <br />
        <div id="ui-view" data-select2-id="ui-view">
            <div>
                <div class="card">
                    <div class="card-header">
                        <p class="text-sm">
                            Voucher No:@Html.EditorFor(model => model.Voucher_No, new { htmlAttributes = new { @style = "width:15%;margin-left:1%;", @readonly = "readonly" } })    Voucher Date :  @Html.TextBoxFor(x => x.Voucher_Date, "{0:yyyy-MM-dd}", new { @type = "date", @style = "width:15%;margin-left:0.25%;", @readonly = "readonly" })
                            Invoice No:@Html.EditorFor(model => model.Invoice_No, new { htmlAttributes = new { @class = "uppercase", required = "required", style = "margin-left:2%;width:15%;", id = "Invoice_No" } })    Invoice Date :  @Html.TextBoxFor(x => x.Invoice_Date, "{0:yyyy-MM-dd}", new { @type = "date", @style = "width:15%;margin-left:1%;" })
                        </p>
                        <p class="text-sm"> &nbsp &nbsp Supplier : &nbsp &nbsp @Html.DropDownListFor(model => model.Supplier, ViewBag.MfdList as SelectList, new { htmlAttributes = new { @style = "width:20%;margin-left:1%;" } })<a id="ToHide" class="btn btn-sm btn-secondary float-right mr-1 d-print-none" href="#" onclick="javascript:window.print();" data-ng-style="true"><i class="fa fa-print"></i> Print</a></p>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <p class="text-sm">
                                Part No : <input id="Part_No" type="text" style="border: 1px solid gray;margin-left:0.5%;margin-right: 1%;width:15%;" class="uppercase" placeholder="Part No"><i class="fa fa-search" id="myBtn" style="margin-right:5%"></i>@Html.DisplayFor(model => model.Part_No)
                                Quantity : <input id="Quantity" type="text" style="border: 1px solid gray; margin-right: 6%; width: 15%;" placeholder="Quantity">
                                Price Per Unit : <input id="Purchase_Rate" type="text" style="border: 1px solid gray; width: 15%;" placeholder="Purchase Rate">
                            </p>
                            <div>
                                <p id="value" style="width:50%" class="text-sm"></p>
                            </div>
                            <div>
                                <p class="text-sm">
                                    Discount : <input id="Discount" type="text" style="border: 1px solid gray; margin-top: 10px; margin-right: 8.5%; width: 15%;" placeholder="Discount">
                                    Tax1 : <input id="Tax_1" type="text" style="border: 1px solid gray; margin-top: 10px; margin-right: 9.5%; width: 15%;" placeholder="Tax 1">
                                    Tax2 : <input id="Tax_2" type="text" style="border: 1px solid gray; margin-top: 10px; margin-right: 8%; width: 15%;" placeholder="Tax 2">
                                    <button class="btn btn-sm btn-secondary" id="Insert">Insert</button>
                                </p>
                            </div>
                            <!-- The Modal -->
                            <div id="myModal" class="modal">

                                <!-- Modal content -->
                                <div class="modal-content">
                                    <i class="close">&times;</i>
                                    <p class="text-sm" style="margin-top:10px;">Choose Part No : @Html.EditorFor(model => model.alphabet, new { htmlAttributes = new { @style = "width:15%;margin-right:1%;", @class = " uppercase" } })</p>
                                    <table class="table text-sm" id="pm_list">
                                        <tbody>
                                            <tr>
                                                <th>
                                                    Product Code
                                                </th>
                                                <th>
                                                    Part No
                                                </th>
                                                <th>
                                                    Description
                                                </th>
                                                <th></th>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <table id="selected_units" class="text-sm font-weight-normal scroll" style="margin-top:10px;">
                                <tbody>
                                    <tr>
                                        <th style="padding-right:50px">Part_No</th>
                                        <th style="padding-right:50px">Description</th>
                                        <th style="padding-right:10px">Quantity</th>
                                        <th style="padding-right:10px">Price</th>
                                        <th style="padding-right:10px">SubTotal</th>
                                        <th style="padding-right:10px">Dis_per</th>
                                        <th style="padding-right:10px">Dis_Rs</th>
                                        <th style="padding-right:10px">Tax1_per</th>
                                        <th style="padding-right:10px">Tax1_Rs</th>
                                        <th style="padding-right:10px">Tax2_per</th>
                                        <th style="padding-right:10px">Tax2_Rs</th>
                                        <th style="padding-right:10px">Total</th>
                                        <th style="display:none;">Invoice_No</th>
                                        <th style="display: none;">Invoice_Date</th>
                                        <th style="display:none;">ILedger</th>
                                        <th style="display: none;">ALedger</th>
                                        <th style="display: none;">final_Qty</th>
                                        <th style="display: none;">final_Sub_Total</th>
                                        <th style="display: none;">final_Discount</th>
                                        <th style="display: none;">final_Tax1</th>
                                        <th style="display: none;">final_Tax2</th>
                                        <th style="display: none;">final_total</th>
                                        <th style="display: none;">supplier</th>
                                    </tr>
                                </tbody>
                            </table>
                            <div>
                                @Html.LabelFor(model => model.Quantity, new { htmlAttributes = new { id = "Qty_Label" } }) : <h6 id="Qty_display"></h6>
                            </div>
                            <div class="float-right">
                                <div>
                                    @Html.LabelFor(model => model.Total, new { htmlAttributes = new { id = "total_Label" } }) : <h6 id="total_display"></h6>
                                </div>
                                <div>
                                    @Html.LabelFor(model => model.Final_Discount) : @Html.EditorFor(model => model.Final_Discount, new { htmlAttributes = new { @id = "Final_Discount" } })
                                </div>
                                <div>
                                    @Html.LabelFor(model => model.Final_Tax1) : @Html.EditorFor(model => model.Final_Tax1, new { htmlAttributes = new { @style = "margin-left:11%;", @id = "Final_Tax1" } })
                                </div>
                                <div>
                                    @Html.LabelFor(model => model.Final_Tax2) : @Html.EditorFor(model => model.Final_Tax2, new { htmlAttributes = new { @style = "margin-left:11%;", @id = "Final_Tax2" } })
                                </div>
                                <div>
                                    @Html.LabelFor(model => model.Final_Total, new { htmlAttributes = new { id = "final_total_Label" } }) : <h6 id="Final_Total" style="margin-left:11%;"></h6>
                                </div>
                            </div>
                            <p id="del"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <p id="Enter_Inv_No"></p>
        <p id="vno" style="background-color:yellow;width:20%"></p>
        <a href="@Url.Action("PurchaseList", "NewPurchase")"><button class="btn btn-sm btn-secondary" style="width:8%;" id="Edit">Edit</button></a><button class="btn btn-sm btn-secondary" id="Submit" style="width:8%;margin-left:2%;">Submit</button>
        <pre id="json_op"></pre>
    </div>
</body>
</html>
<script>
    var qty = 0;
    var total = 0;
    var final_total = 0;
    var i = 1;
    var val = "";
    $('#Insert').click(function () {
        var d1 = $('#Part_No').val();
        var d2 = parseInt(document.getElementById("Quantity").value);
        var d3 = $('#Purchase_Rate').val();
        var d4 = $('#Discount').val();
        var d5 = $('#Tax_1').val();
        var d6 = $('#Tax_2').val();
        var mfr = $('#Supplier').val();
        var ILedger = 1;
        var ALedger = 2;

        var last_row1 = document.getElementById("selected_units").tBodies[0].rows.length;
        var l_row1 = last_row1 - 1;
        var count = 1;
        for (var i = 0; i < l_row1; i++) {
            var e_part_no = document.getElementById("selected_units").tBodies[0].rows[count].cells[0].innerHTML;
            var e_partno = document.getElementById("Part_No").value;
            if (e_part_no == e_partno) {
                var qty_err = '<p style="color:red;">Part No is already exists !!!<p/>';
                document.getElementById("value").innerHTML = qty_err;
                return;
            }
            count++;
        }
        var subtotal = d2 * d3;
        if (d4 == "") {
            var discount = 0;
            var discount_per = 0;
        }
        else {
            var discount = (subtotal * d4) / 100;
            var discount_per = (discount / subtotal) * 100;
        }
        if (d5 == "") {
            var tax1 = 0;
            var tax1_per = 0;
        }
        else {
            var tax1 = (subtotal * d5) / 100;
            var tax1_per = (tax1 / subtotal) * 100;
        }
        if (d6 == "") {
            var tax2 = 0;
            var tax2_per = 0;
        }
        else {
            var tax2 = (subtotal * d6) / 100;
            var tax2_per = (tax2 / subtotal) * 100;
        }

        var Invoice_No = $('#Invoice_No').val();
        var Invoice_Date = $('#Invoice_Date').val();
        var qty_field = $('#Quantity').val();
        if (d1 == "" || d2 == "" || d3 == "") {
            document.getElementById("Qty_display").innerHTML = 0;
            document.getElementById("total_display").innerHTML = 0;
        }
        else {
            qty = qty + d2;
            var Total = (subtotal - discount) + tax1 + tax2;
            total = total + Total;
            document.getElementById("Qty_display").innerHTML = qty;
            document.getElementById("total_display").innerHTML = total;
        }
        var final_Qty = document.getElementById("Qty_display").innerHTML;
        var final_Total = document.getElementById("total_display").innerHTML;
        var final_discount = $("#Final_Discount").val();
        var final_tax1 = $("#Final_Tax1").val();
        var final_tax2 = $("#Final_Tax2").val();
        var model = new Object();
            model.Part_No = document.getElementById("Part_No").value;

            jQuery.ajax({
            type: "POST",
            url: "@Url.Action("P_to_DQ")",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ name: model }),
                success: function (data) {
                    if (d1 == "") {
                        var error = '<p style="color:red;">Enter Part No !!!<p/>';
                        document.getElementById("value").innerHTML = error;
                        return;
                    }
                    else if (qty_field == "" || qty_field == 0) {
                        var error = '<p style="color:red;">Enter Quantity !!!<p/>';
                        document.getElementById("value").innerHTML = error;
                        return;
                    }
                    else if (d3 == "" || d3 == 0) {
                        var error = '<p style="color:red;">Enter Price per unit !!!<p/>';
                        document.getElementById("value").innerHTML = error;
                        return;
                    }
                    else if (Invoice_No == "") {
                        var error = '<p style="color:red;">Enter Invoice No !!!<p/>';
                        document.getElementById("value").innerHTML = error;
                        return;
                    }
                    else {
                        document.getElementById("value").innerHTML = val;
                        var newrow = '<tr id="data"><td>' + d1 + '</td><td>' + data[0].Description + '</td><td id="Qty' + i + '">' + d2 + '</td><td>' + d3 + '</td><td>' + subtotal.toFixed(2) + '</td><td>' + discount_per + '</td><td>' + discount + '</td><td>' + tax1_per + '</td><td>' + tax1 + '</td><td>' + tax2_per + '</td><td>' + tax2 + '</td><td id="total' + i + '">' + Total + '</td><td style="display:none;">' + Invoice_No + '</td><td style="display:none;">' + Invoice_Date + '</td><td style="display:none;">' + ILedger + '</td><td style="display:none;">' + ALedger + '</td><td style="display:none;">' + final_Qty + '</td><td style="display:none;">' + final_Total + '</td><td style="display:none;">' + final_discount + '</td><td style="display:none;">' + final_tax1 + '</td><td style="display:none;">' + final_tax2 + '</td><td id="Final_Total_last" style="display:none;"></td><td style="display:none;">' + mfr + '</td></tr>';
                        $('#selected_units tr:last').after(newrow);
                        i++;
                    }
                },
                failure: function (errMsg) {
                    alert(errMsg);
                }
            });
        formClear();
        final_calculation();
    });

    function formClear() {
        $("#Part_No").val("");
        $("#Quantity").val("");
        $("#Purchase_Rate").val("");
        $("#Discount").val("");
        $("#Tax_1").val("");
        $("#Tax_2").val("");
    }

    function final_calculation() {
        var sub_total = document.getElementById("total_display").innerHTML;
        var final_discount = $("#Final_Discount").val();
        var final_tax1 = $("#Final_Tax1").val();
        var final_tax2 = $("#Final_Tax2").val();
        if (final_discount == "") {
            var discount_val = 0;
        }
        else {
            var discount_val = (sub_total * final_discount) / 100;
        }
        if (final_tax1 == "") {
            var tax1_val = 0;
        }
        else {
            var tax1_val = (sub_total * final_tax1) / 100;
        }
        if (final_tax2 == "") {
            var tax2_val = 0;
        }
        else {
            var tax2_val = (sub_total * final_tax2) / 100;
        }
        var Total = (sub_total - discount_val) + tax1_val + tax2_val;
        document.getElementById("Final_Total").innerHTML = Total;
    }

    $('#Submit').click(function (e) {
        final_calculation();
        var Inv_No = $('#Invoice_No').val();
        var part = document.getElementById("selected_units").tBodies[0].rows.length;
        if (Inv_No == "" || part==1) {
            document.getElementById("Enter_Inv_No").innerHTML = "Enter Invoice No (or) Table is Empty !!!";
            return;
        }
        else {
            document.getElementById("Final_Total_last").innerHTML = document.getElementById("Final_Total").innerHTML;
            var submit1 = "";
            document.getElementById("Enter_Inv_No").innerHTML = submit1;
            var myRows = [];
            var headersText = [];
            var $headers = $("#selected_units th");
            var $rows = $("#selected_units tbody #data").each(function (index) {
                $cells = $(this).find("td");
                myRows[index] = {};

                $cells.each(function (cellIndex) {
                    if (headersText[cellIndex] === undefined) {
                        headersText[cellIndex] = $($headers[cellIndex]).text();
                    }
                    myRows[index][headersText[cellIndex]] = $(this).text();
                });
            });

            var myObj = {
                "myrows": myRows
            };
            $.ajax({
                url: '/NewPurchase/Table_Data',
                data: JSON.stringify(myRows),
                type: 'POST',
                contentType: 'application/json;',
                dataType: 'json',
                success: function (result) {
                    //alert(result.ItemList[0].Str);
                    var data = result;
                    document.getElementById("vno").innerHTML = "Your Voucher.No is " + data + "";
                    var submit = "Submitted Successfully !!!";
                    document.getElementById("Enter_Inv_No").innerHTML = submit;
                }
            });
            @*document.getElementById("json_op").innerHTML = JSON.stringify(myRows, undefined, 2);*@

        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.keyCode === 9) {
            var Inv_No = $('#Invoice_No').val();
            var model = new Object();
            model.Part_to_Descp = document.getElementById("Part_No").value;

            jQuery.ajax({
            type: "POST",
            url: "@Url.Action("Partno_to_Descp")",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ name: model }),
                success: function (data) {
                    const button = document.getElementById("Insert");
                    if(Inv_No == "") {
                        var qty_err = '<p style="color:red;">Enter Invoice No !!!<p/>';
                        document.getElementById("Enter_Inv_No").innerHTML = qty_err;
                        return;
                    }
                    else if (data[1] == "") {
                        button.disabled = true;
                        var inv = "";
                        document.getElementById("Enter_Inv_No").innerHTML = inv;
                    }

                    else {
                        button.disabled = false;
                        var inv = "";
                        document.getElementById("Enter_Inv_No").innerHTML = inv;
                    }
                    document.getElementById("value").innerHTML = data[0];
            },
            failure: function (errMsg) {
                alert(errMsg);
            }
            });
        }
    });

    var modal = document.getElementById("myModal");
    var btn = document.getElementById("myBtn");
    var span = document.getElementsByClassName("close")[0];
    var select = document.getElementById("select_partno");

    btn.onclick = function () {
        modal.style.display = "block";
    }
    span.onclick = function () {
        modal.style.display = "none";
    }
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    btn.addEventListener("click", list);
    span.removeEventListener("click", list);
    select.removeEventListener("click", list);
    window.removeEventListener("click", list);

    function list() {
        document.addEventListener("keyup", function (event) {
            var letter = document.querySelector("#alphabet").value;
            var model = new Object();
            model.alphabet = letter;
            $.ajax({
                url: '/NewPurchase/PM_List',
                data: JSON.stringify({ name: model }),
                type: 'POST',
                contentType: 'application/json;',
                dataType: 'json',
                success: function (result) {
                    $("#pm_list").find("tr:not(:first)").remove();
                    for (var i = 0; i <= result.length - 1; i++) {
                        var newrow = '<tr id="list" onclick="List_to_View()"><td>' + result[i].P_code + '</td><td>' + result[i].Part_No + '</td><td>' + result[i].Description + '</td></tr>';
                        $('#pm_list tr:last').after(newrow);
                    }
                }
            });
        })
    }

    function List_to_View() {
        var table = document.getElementById('pm_list');
        for (var i = 0; i < table.rows.length; i++) {
            table.rows[i].addEventListener('click', function () {
                var partno = this.cells[1].innerHTML;
                document.getElementById("Part_No").value = partno;
                modal.style.display = "none";
            });
        }
    }
</script>
